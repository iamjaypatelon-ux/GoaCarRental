<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Available Cars</title>

<style>
  .summary-box{
  background:#ffffff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,0.05);
  margin-bottom:20px;
  border-left:4px solid #25D366;
}

.summary-box p{
  margin:6px 0;
  font-size:14px;
}

  .edit-btn{
  margin-top:10px;
  background:#075E54;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  font-size:13px;
  cursor:pointer;
}
.edit-btn:hover{
  background:#064c43;
}
  
body{font-family:sans-serif;background:#f5f7f6;margin:0;padding:15px;}
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
  gap:15px;
}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,0.05);
}
.card img{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  border-radius:10px;
}
.btn{
  background:#25D366;
  color:#fff;
  padding:10px;
  border:none;
  border-radius:6px;
  width:100%;
  margin-top:10px;
}
.highlight{
  background:#e6f7f1;
  padding:6px;
  border-radius:6px;
  margin:6px 0;
  font-weight:600;
}
.section-header{
  background:#ffffff;
  padding:14px;
  border-radius:10px;
  margin-top:20px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
  font-weight:600;
  color:#075E54;
}

.section-header span{
  font-size:18px;
  transition:0.3s;
}

.section-grid{
  margin-top:15px;
  display:none;
}

.section-grid.active{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
  gap:15px;
}</style>
</head>

<body>

<h2>Available Cars</h2>
<div id="bookingSummary" class="summary-box"></div>
<div id="carGrid"></div>
<script>

// Correct cars array
const cars = [

  // Compact
  {name:"Ignis Manual", rate:1000, deposit:3000, advance:1000, fixed:1000, image:"Ignis (Manual).png", category:"compact"},
  {name:"Swift Manual", rate:1000, deposit:3000, advance:1000, fixed:1000, image:"Swift (Manual).png", category:"compact"},
  {name:"Baleno Manual", rate:1000, deposit:3000, advance:1000, fixed:1500, image:"Baleno (Manual).png", category:"compact"},
{name:"i20 Manual", rate:1100, deposit:3000, advance:1000, fixed:1500, image:"i20 (Manual).png", category:"compact"},
  
  // Premium
  {name:"Hycross Automatic", rate:3000, deposit:5000, advance:2000, fixed:2000, image:"Toyota Innova Hycross.png", category:"premium"},

  // Adventure
  {name:"Thar Manual", rate:2500, deposit:5000, advance:2000, fixed:2000, image:"Thar 4x4 (Manual).png", category:"adventure"},

  // Family
  {name:"Innova Crysta", rate:2800, deposit:6000, advance:2000, fixed:2500, image:"crysta.png", category:"family"},

  // Luxury
  {name:"Fortuner", rate:4500, deposit:15000, advance:5000, fixed:3000, image:"fortuner.png", category:"luxury"}

];

  
const categories = {
  compact: "Compact & Mid-Size Cars (5-Seaters)",
  premium: "Premium (5-Seaters)",
  adventure: "Adventure Rides – Thar Collection",
  family: "Family & Group Rides (7-Seaters & SUVs)",
  luxury: "Exclusive Luxury Cars"
};

// URL params
const params = new URLSearchParams(window.location.search);

if(!params.get("pickup")){
  document.getElementById("carGrid").innerHTML = "<h3>Please go back and select dates.</h3>";
  throw new Error("Missing booking details");
}

const pickup = new Date(params.get("pickup"));
const drop = new Date(params.get("drop"));
const pickupLoc = params.get("pickupLoc");
const dropLoc = params.get("dropLoc");

function formatDateTime(date){

  const options = {
    day:'numeric',
    month:'long',
    year:'numeric',
    hour:'numeric',
    minute:'2-digit',
    hour12:true
  };

  return date.toLocaleString('en-IN', options);
}  
  
// Billing logic
function billingPickup(d){
  let x = new Date(d);

  // Before 4AM → previous day
  if(x.getHours() < 4){
    x.setDate(x.getDate() - 1);
  }

  x.setHours(9,0,0,0);
  return x;
}

function billingDrop(d){
  let x = new Date(d);

  // After 9:30AM → next day
  if(
    x.getHours() > 9 ||
    (x.getHours() === 9 && x.getMinutes() > 30)
  ){
    x.setDate(x.getDate() + 1);
  }

  x.setHours(9,0,0,0);
  return x;
}
  
let days = Math.ceil(
  (billingDrop(drop)-billingPickup(pickup))/(1000*60*60*24)
);
if(days<1) days=1;

  // Minimum 3 days rule
if(days <= 2){
  document.getElementById("carGrid").innerHTML = `
    <div style="
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 5px 15px rgba(0,0,0,0.05);
      text-align:center;
      margin-top:20px;
    ">
      <h3 style="color:#075E54;">No Cars Available</h3>
      <p>Minimum booking duration is 3 days.</p>
      <button onclick="goBackToEdit()" style="
        margin-top:15px;
        padding:10px 15px;
        background:#075E54;
        color:#fff;
        border:none;
        border-radius:6px;
        cursor:pointer;
      ">Modify Dates</button>
    </div>
  `;
  throw new Error("Minimum booking rule triggered");
}
  
function isNight(hour){
  return (hour < 9 || hour >= 21);
}

let pickupHour = pickup.getHours();
let dropHour = drop.getHours();

let nightCondition =
  isNight(pickupHour) || isNight(dropHour);

let specialLocations = [
  "Karmali Station",
  "Madgaon",
  "Madgaon Railway Station",
  "Madgaon Bus Stand",
  "Majorda",
  "Morjim"
];

let isSpecial =
  specialLocations.includes(pickupLoc) ||
  specialLocations.includes(dropLoc);

let deliveryCharge;

if(isSpecial){
  // Special locations pricing
  deliveryCharge = nightCondition ? 1000 : 800;
}else{
  // Normal locations pricing
  deliveryCharge = nightCondition ? 800 : 500;
}

let grid = document.getElementById("carGrid");
// Show booking summary
document.getElementById("bookingSummary").innerHTML = `
  <p><strong>Car Delivery :</strong> ${formatDateTime(pickup)}, ${pickupLoc}</p>
  <p><strong>Car Return :</strong> ${formatDateTime(drop)}, ${dropLoc}</p>
  <button class="edit-btn" onclick="goBackToEdit()">Edit Details</button>
`;
  
  Object.keys(categories).forEach(catKey => {

  let filteredCars = cars.filter(car => car.category === catKey);
  if(filteredCars.length === 0) return;

  // Section Header
  let header = document.createElement("div");
  header.className = "section-header";
  header.innerHTML = `
    ${categories[catKey]}
    <span>+</span>
  `;
  grid.appendChild(header);

  // Section Grid
  let sectionGrid = document.createElement("div");
  sectionGrid.className = "section-grid";
  grid.appendChild(sectionGrid);

  filteredCars.forEach(car => {

    let rent = (car.rate * days) + deliveryCharge + car.fixed;
    let payable = rent + car.deposit;
    let balance = payable - car.advance;

    let card = `
    <div class="card">
      <img src="${car.image}">
      <h4>${car.name}</h4>
      <p>Total Rent: ₹${rent}</p>
      <p>Refundable Deposit: ₹${car.deposit}</p>
      <div class="highlight">
        Total Payable: ₹${payable}
      </div>
      <p>Advance: ₹${car.advance}</p>
      <p><strong>To Pay During Delivery: ₹${balance}</strong></p>
      <button class="btn"
        onclick="book('${car.name}',${rent},${car.deposit},${payable},${car.advance},${balance})">
        Book Now
      </button>
    </div>
    `;

    sectionGrid.innerHTML += card;
  });

  // Toggle open / close
  header.addEventListener("click", function(){

    sectionGrid.classList.toggle("active");

    let icon = header.querySelector("span");

    if(sectionGrid.classList.contains("active")){
      icon.innerText = "−";
    }else{
      icon.innerText = "+";
    }

  });

});

function goBackToEdit(){

  let url = "test_bookingpage.html?pickup=" + encodeURIComponent(params.get("pickup")) +
            "&drop=" + encodeURIComponent(params.get("drop")) +
            "&pickupLoc=" + encodeURIComponent(pickupLoc) +
            "&dropLoc=" + encodeURIComponent(dropLoc);

  window.location.href = url;
}
  
// WhatsApp function
function book(name,rent,deposit,payable,advance,balance){

let message =
`*Delivery* - ${formatDateTime(pickup)}, ${pickupLoc}
*Return* - ${formatDateTime(drop)}, ${dropLoc}
*Car Model* - ${name}
_________________________
*Total Rent* - ₹${rent}
*Refundable Deposit* - ₹${deposit}
_________________________
*Total Amount* - ₹${payable}
*Advance* - ₹${advance}
*Payable at Delivery* - ₹${balance}
_________________________
I want to book ${name}.
Please share your QR for advance payment.`;

let url="https://wa.me/917984509196?text="+encodeURIComponent(message);
window.open(url,"_blank");
}</script>

</body>
</html>
